<html>
<% totalpaid=0;examsheld=0;tested=0;xapplied=0; approved=0; fee=0; collected=0;disapproved=0;passed=0;perf_passed=0;fta=0;withdrew=0;failed=0;perf_failed=0;perf_waived=0;inactive=0;appointed=0;%>

<head>
		<style type="text/css">

			html, body { padding: 0; margin: 0; border: 0; }
			body, td, th { font: 11px/13px Trebuchet MS, Verdana, Arial, sans-serif; }
			table { border-collapse: collapse; }
			td, th { text-align: left; padding: 3px 5px; vertical-align: top; border-bottom: 1px solid #888; }
			th { font-weight: bold; white-space: nowrap; border-top: 1px solid #888; vertical-align: bottom; }
			h1 { text-align: center; font-size: 100%; }
			h1.big { font-size: 16px; line-height: 18px; }
			tr.small th { font-size: 8px; border-top: none; }
			/* thead, tfoot { display: table-row-group } */
			tr { page-break-inside: avoid; }
			.nobr { white-space: nowrap; }
			.face-sheet th, .face-sheet td { border: none; padding-left: 0; }
			.xline, .face-fill { border-bottom: 1px solid #000; text-align: center; }
			.xline { width: 30px; display: inline-block; }
		</style>
	</head>
	<body>
		<% first = true %>
		<% if params[:veterans] %>
			<h1>Veterans Information For Exams Given From: <%= @report[:from_date].d0? %> To: <%= @report[:to_date].d0? %></h1>
			<table>
				<tr>
					<th class="nobr">Name<br />Enlisted Date</th>
					<th class="nobr">Served From<br />Served To</th>
					<th class="nobr">Hon. Discharge<br />Reason</th>
					<th class="nobr">VC Type<br />Dis. Claim No.</th>
					<th class="nobr">Dis. Auth. Date<br />DD214 Inc.</th>
					<th class="nobr">VS Used<br />Where Used</th>
				</tr>
				<% @objs.each { |o| %>
					<tr>
						<td>
							<%= h o.person.last_name %> <%= h o.person.first_name %>&nbsp;<br />
							<%= o.army_enlisted.d0? %>&nbsp;
						</td>
						<td>
							<%= o.army_from.d0? %>&nbsp;<br />
							<%= o.army_to.d0? %>
						</td>
						<td>
							<%= o.army_discharge_honorable.nil? ? '' : o.army_discharge_honorable ? 'YES' : '**NO**' %>&nbsp;<br />
							<%= h o.army_discharge_reason %>
						</td>
						<td>
							<%= o.vc_type %>&nbsp;<br />
							<%= h o.vc_disabled_claim_no %>
						</td>
						<td>
							<%= o.vc_disabled_auth_date.d0? %>&nbsp;<br />
							<%= o.dd214_included.nil? ? '' : o.dd214_included ? 'YES' : 'NO'  %>
						</td>
						<td>
							<%= o.vc_used.nil? ? '' : o.vc_used ? 'YES' : 'NO' %>&nbsp;<br />
							<%= h o.vc_used_agency %>
						</td>
					</tr>
				<% } %>
			</table>
			
		<% elsif params[:special_accommodations] %>
			<h1>Special Accommodations For Exams Given From: <%= @report[:from_date].d0? %> To: <%= @report[:to_date].d0? %></h1>
			<p>
				<strong>Req.?</strong> - Indicates if special accommodations were requested on online application.<br />
				<strong>(NO DOC)</strong> - Indicates documentation for special accommodations/sabbath observer was not provided.
			</p>
			
			<table width="100%">
				<tr>
					<th>Name</th>
					<th>Exam#</th>
					<th>Req.?</th>
					<th>Spec.&nbsp;Acc.</th>
					<th>Sabbath</th>
				</tr>
				<% @objs.each { |o| %>
					<tr>
						<td><%= h o.last_name %>, <%= o.first_name %></td>
						<td style="white-space: nowrap;"><%= h o.exam_no %></td>
						<td style="white-space: nowrap;"><%= o.web_special_accommodations == '1' ? 'YES' : '' %></td>
						<td>
							<%= o.special_accommodations %>
							<% if !o.special_accommodations.blank? %>
								<%= h o.special_accommodations %> <% if o.special_accommodations_docs == '0' %>(NO DOC)<% end %>
							<% end %>
						</td>
						<td style="white-space: nowrap;">
							<% if o.sabbath_observer == '1' %>
								YES <% if o.sabbath_observer_docs == '0' %>(NO DOC)<% end %>
							<% end %>
						</td>
					</tr>
				<% } %>
			</table>
		<% elsif params[:contact_preference] %>
			<h1>Contact Preference Totals For Exams Given From: <%= @report[:from_date].d0? %> To: <%= @report[:to_date].d0? %></h1>
			<table>
				<tr>
					<th>Postal</th>
					<th>Email</th>
					<th>Both</th>
				</tr>
				<tr>
					<td><%= nwp @objs.postal_count, 0 %></td>
					<td><%= nwp @objs.email_count, 0 %></td>
					<td><%= nwp @objs.both_count, 0 %></td>
				</tr>
			</table>
		<% elsif params[:cross_filing] %>
			<h1>Cross Filing For Exams Given From: <%= @report[:from_date].d0? %> To: <%= @report[:to_date].d0? %></h1>
			<table>
				<tr>
					<th>Name</th>
					<th>Exam</th>
					<th>Cross Filing At</th>
					<th>Other Exams</th>
				</tr>
				<% @objs.each { |o| %>
					<tr>
						<td><%= h o.person.last_name %>, <%= h o.person.first_name %></td>
						<td><%= h o.exam.exam_no %> - <%= h o.exam.title %></td>
						<td><%= h o.cross_filing_at %></td>
						<td>
							<%= nl2br_h o.cross_filing_exams %>
						</td>
					</tr>
				<% } %>
			</table>
		
		
		<% elsif params[:exam_sites] %>
			<%
				grouped = {}
				room_totals = {}
				exam_totals = {}
				room_objs = {}
				exam_objs = {}
				@objs.each { |o|
					exam = "#{o.exam_no} #{o.title}"
					exam_objs[exam] = o
					o.applicants.each { |a|
						room = a.exam_site ? a.exam_site.name : 'UNKNOWN SITE'
						room_objs[room] = a.exam_site
						grouped[room] ||= {}
						grouped[room][exam] ||= []
						grouped[room][exam] << a
						exam_totals[exam] ||= 0
						exam_totals[exam] += 1
						room_totals[room] ||= 0
						room_totals[room] += 1
					}
				}
			%>
			<% grouped.keys.sort.each { |r| exams = grouped[r]; exam_keys = exams.keys.sort %>				
				<% room = room_objs[r] %>
				<% if room && @report.face_sheet.to_i != 0 %>
					<% 
						session = ExamSiteSession.find_by_exam_site_id_and_given_on(room.id, @report[:from_date]) || {} 
						room_name = room.name.split('-').map(&:strip)
					%>
					
					<h1 class="big" <% unless first %> style="page-break-before: always;"<% end %>><%= room_name[0].to_s.strip %><br>
					PLEASE PICK UP AND RETURN MATERIALS TO ROOM <span class="xline" style="width: 120px;">&nbsp;<%= room.exam_site_group ? room.exam_site_group.head_proctor_room.to_s.sub(/^ROOM\s*/, '') : '' %>&nbsp;</span></h1>
					<div class="face-sheet">
						<% first = false %>
						<table width="100%">
							<tr>
								<th width="1%">PROCTOR</td>
								<td width="80%"><div class="face-fill"><%= session.proctor %>&nbsp;</div></td>
								<th width="1%">ROOM&nbsp;NUMBER</th>
								<td width="20%"><div class="face-fill">&nbsp;<%= room_name[1].to_s.strip.sub(/^ROOM\s*/, '') %>&nbsp;</div></td>
							</tr>
							<tr>
								<th>EXAM&nbsp;SERIES&nbsp;DATE</th>
								<td><div class="face-fill"><%= @report[:from_date].strftime '%B %d, %Y' %>&nbsp;</div></td>
								<th>EXAM&nbsp;START:</th>
								<td><div class="face-fill"><%= exam_keys.map { |k| exam_objs[k].given_at }.min.t0? %>&nbsp;</div></td>
							</tr>
						</table>
						<% 
							# Make sure calculator_prohibited? is the same for all exams
							calc_allowed = true
							cp0 = exam_objs[exam_keys[0]].calculator_prohibited?
							calc_same = exam_keys.all? { |k| 
								cp = exam_objs[k].calculator_prohibited?
								calc_allowed &&= !cp
								cp0 == cp
							} 
						%>
						<p>Arithmetic CALCULATORS and slide rules allowed: 
							YES <span class="xline">&nbsp;<% if calc_same && calc_allowed %>X<% end %>&nbsp;</span>
							NO <span class="xline">&nbsp;<% if calc_same && !calc_allowed %>X<% end %>&nbsp;</span>
						</p>
						<table width="100%">
							<tr>
								<th width="70%">EXAM&nbsp;TITLE&nbsp;REVIEW</th>
								<th width="10%">EXAM&nbsp;#</th>
								<th width="10%">BOOK&nbsp;#</th>
								<th width="10%">TIME&nbsp;LIMIT</th>
							</tr>
							<%= cross_counter = Hash.new { |h, k| h[k] = 0 } %>
							<% exam_keys.each { |k| e = exam_objs[k] %>
								<% book_nos = e.program_no.to_s.split(',') %>
								<tr>
									<td>
										<%= e.title %> (<%= exams[k].size %>)<br>
										<% exams[k].each { |a| cross_counter[a.person_id] += 1 } %>
										<%= book_nos.size %> orange answer sheet<br>
										1 green candidate ID sheet
									</td>
									<td class="nobr"><%= e.exam_no %></td>
									<td class="nobr"><%= book_nos.join('<br>') %></td>
									<td class="nobr"><% if e.exam_length.to_f > 0 %><%= e.exam_length %> hours<% end %></td>
								</tr>
							<% } %>
						</table>
						<% cross_counter = cross_counter.values.select { |cc| cc > 1 }.size %>
						<p><b><% if cross_counter > 0 %><%= cross_counter %> Crossfilers - Same/Different Series<% else %>NO CROSSFILERS<% end %></b></p>
						<% if exam_keys.any? { |k| exam_objs[k].high_security } %>
							<p><b><u>Special Monitor Instructions - NO SCRATCH PAPER</u></b></p>
							<p><b><u>VERY IMPORTANT - This is a high security exam with serial numbered booklets. Please follow the Monitors  instructions from State carefully.</u></b></p>
						<% end %>
						<p>Purple Bio Data Sheet, completion of PART B - Check candidate directions.</p>
						<p>Veteran credit forms due in 1 month: <%= (@report[:from_date] + 1.month).strftime '%B %d, %Y' %></p>
						<p><b><u>Note:</u> If a discrepancy exists between this sheet and the information provided by NYS on the exam booklet or candidate 
						directions you should always follow the information provided by New York State.</b></p>
					</div>
				<% end %>
				
				<% exam_keys.each { |e| objs = exams[e] %>
					
					<h1<% unless first %> style="page-break-before: always;"<% end %>>
						Exams/Sites For Exams Given From: <%= @report[:from_date].d0? %> To: <%= @report[:to_date].d0? %><br />
						Exam: <%= h e %><br />
						Site: <%= h r %>
					</h1>
					<% first = false %>
					<table>
						<tr>
							<th width="48%">Applicant</th>
							<th width="1">Present</th>
							<th width="1">FTA</th>
							<th width="48%">Applicant</th>
							<th width="1">Present</th>
							<th width="1">FTA</th>
						</tr>
					</table>
					<% tfirst = true %>
					<% sgrps = objs.in_groups_of(48, false) { |sgrp| %>
						<table<% if !tfirst %> style="page-break-before: always;"<% end %> width="100%">
							<% tfirst = false %>
							<% grps = sgrp.in_groups(2) %>
							<% 0.upto(grps[0].size - 1) { |j| %>
								<tr>
									<% 0.upto(1) { |i| %>
										<% a = grps[i][j] %>
										<% if a %>
											<td width="50%">
												<%= h a.person.last_name %>, <%= h a.person.first_name %><br />
												xxxx-xx-<%= h a.person.ssn_last4 %>
											</td>
										<% else %>
											<td width="50%"></td>
										<% end %>
									<% } %>
								</tr>
							<% } %>
						</table>
					<% } %>
					<p>
						<%= h e %> / <%= h r %> TOTAL: <%= objs.size %><br />
						<%= h e %> TOTAL: <%= exam_totals[e] %><br />
						<%= h r %> TOTAL: <%= room_totals[r] %>
					</p>
					
				<% } %>
			<% } %>
		
		<% elsif params[:statistics] %>
		
			<h1>Exam Totals and Statistics<br />For Exams Given From: <%= @report[:from_date].d0? %> To: <%= @report[:to_date].d0? %></h1>
		
		
			<table width="100%">
				<thead>
					<tr>
						<th style="border-bottom: none;">Exam&nbsp;Date</th>
						<th style="border-bottom: none;" colspan="15">Title and Number</th>
					</tr>
					<tr class="small">
						<th>Fee</th>
						<!--<th>Total<br />Collected</th>-->
						<th>Type</th>
						<th>List<br />Established</th>
						<th>Applied</th>
						<th>Approved</th>
						<th>Disapproved</th>
						<th>Pass<br />Writ.</th>
						<th>Pass<br />Perf.</th>
						<th>FTA</th>
						<th>Withdrew</th>
						<th>Fail<br />Writ.</th>
						<th>Fail<br />Perf.</th>
						<th>Perf.<br />Waiv.</th
						<th>Inactive</th>
						<th>Appt'd</th>
					</tr>
				</thead>
				<tbody>
            		<% @objs.each { |o| %>
						<tr>
							<td style="border-bottom: none;"><%= Date.parse(o.given_at).d0? %></td>
							<td style="border-bottom: none;" colspan="16"><%= h o.title %>: <%= h o.exam_no %></td>
						</tr>
						<tr>
                          <% examsheld+=1 %>
							<td><%= o.fee%>/<%= o.paid_by.to_i %>/<%= number_to_currency(o.total_paid.to_i) %><% fee +=o.paid_by.to_i %></td>
                          <% totalpaid +=o.total_paid.to_i %>
							<!--<td><%= o.collected;collected+=o.collected.to_i; %></td>-->
							<td><%= o.exam_type %></td>
							<td><%= Date.parse(o.established_date).d0? rescue nil %></td>
							<td><%= o.applied %><% xapplied+=o.applied.to_i%></td>
							<td><%= o.approved %><% approved+=o.approved.to_i%></td>
							<td><%= o.disapproved %><% disapproved+=o.disapproved.to_i %></td>
							<td><%= o.passed %><% passed+=o.passed.to_i %></td>
							<td><%= o.perf_passed%><% perf_passed+=o.perf_passed.to_i %></td>
							<td><%= o.fta %><% fta+=o.fta.to_i %></td>
							<td><%= o.withdrew %> <% withdrew+=o.widthdrew.to_i %></td>
							<td><%= o.failed %><% failed+=o.failed.to_i %></td>
							<td><%= o.perf_failed%> <% perf_failed+=o.perf_failed.to_i %></td>
							<td><%= o.perf_waived%> <% perf_waived+=o.perf_waived.to_i %></td>
							<td><%= o.inactive%> <% inactive+=o.inactive.to_i %></td>
							<td><%= o.appointed%> <% appointed+=o.appointed.to_i %></td>
						</tr>
					<% } %>
                    <tr>
                      <td>Total # Fees <%= fee %><br><%= number_to_currency(totalpaid) %></td>
                      <!--<td></td>-->
                      <td>***TOTALS *** <%=examsheld %> Exams Held</td>
                      <td></td>
                      <td><%= xapplied %></td>
                      <td><%= approved %></td>
                      <td><%= disapproved %></td>
                      <td><%= passed %></td>
                      <td><%= perf_passed %></td>
                      <td><%= fta %></td>
                      <td><%= withdrew %></td>
                      <td><%= failed %></td>
                      <td><%= perf_failed %></td>
                      <td><%= perf_waived %></td>
                      <td><%= inactive %></td>
                      <td><%= appointed %></td>
                    </tr>
                <tr><td colspan="16" align="center" width="100%"><br>Total Tested <%= approved - fta %></td></tr>
				</tbody>
				
			</table>
		
		<% elsif @report[:separate_exams] == '1' %>
			
			<% @objs.each_with_index { |e, i| %>
				
				<h1<% if i > 0 %> style="page-break-before: always;"<% end %>>Attendance list for <%= e.exam_no %> <%= e.title %>, <%= e.given_at.d0? %>
				
				<% if params[:performance] %>
					<% exam_perfs = e.exam_perfs.find(:all, :include => :perf_test, :order => 'perf_tests.name') %>
				<% end %>
				
				<table width="100%">
					<thead>
						<tr>
							<th width="25%">Name</th>
							<th width="15%">SSN</th>
							<th width="60%"><div style="float: right;">Status</div>Exams Attending</th>
						</tr>
					</thead>
					<tbody>
						<%
						
						no_present = 0
						no_withdrew = 0
						no_fta = 0
						
						%>
						<% e.applicants.each { |a| p = a.person %>
							<%
							
							if a.app_status
								if a.app_status.code == '-'
									no_fta += 1
								elsif no_withdrew == 'W'
									no_withdrew += 1
								else
									no_present += 1
								end
							end
							
							
							%>
							<tr>
								<td>
									<%= h p.last_name %>, <%= h p.first_name %>
									<% if p.sabbath_observer %>
										<strong>
											**SABBATH OBS.
											<% if !p.sabbath_observer_docs %>
												(NO DOC.)
											<% end %>
										</strong>
									<% end %>
									<% if !p.special_accommodations.blank? %>
										<br />
										<strong>
											**<%= h p.special_accommodations %>
											<% if !p.special_accommodations_docs %>
												(NO DOC.)
											<% end %>
										</strong>
									<% end %>
									<% if a.web_applicant && a.web_applicant.special_accommodations %>
										<strong>** REQ. ACC.</strong>
									<% end %>
									<% if a.alternate_exam_date %>
										<strong>**ALT DATE: <%= a.alternate_exam_date.d0? %></strong>
									<% end %>
								</td>
								<td>
									<% if @report[:full_ssn] == '1' %>
										<%= h p.ssn %>
									<% else %>
										xxx-xx-<%= h p.ssn_last4 %>
									<% end %>
								</td>
								<td>
									<div>
										<div style="float: right;"><%= a.app_status ? a.app_status.name : '' %></div>
										<% if params[:performance] %>
											<% exam_perfs.each { |ep| %>
												<% taken_perf = p.taken_perfs.find(:first, :include => :perf_code, :conditions => ['taken_perfs.exam_id = ? and taken_perfs.perf_test_id = ?', e.id, ep.perf_test_id]) %>
												<div>
													<%= ep.perf_test.name %>: 
													<% if taken_perf %>
														<% if taken_perf.perf_code %>
															<%= taken_perf.perf_code.label %>
														<% end %>
														<%= taken_perf.date_taken.d0? %>
														<%= h taken_perf.time_taken %>
														<%= h taken_perf.notes %>
													<% end %>
												</div>
											<% } %>
										<% else %>
											<%= h a.exam.title %>: <%= h a.exam.exam_no %><br />
											Exam Site: <%= h a.exam_site.name if a.exam_site %>
										<% end %>
									</div>
								</td>
							</tr>
						<% } %>
					</tbody>
				</table>
				<p style="text-align: left;">TOTAL FOR EXAM: <%= e.applicants.size %><br />
				TOTAL PRESENT: <%= no_present %><br />
				TOTAL WITHDREW: <%= no_withdrew %><br />
				TOTAL FTA: <%= no_fta %></p>
			<% } %>
					
		<% else %>
			
			<%
			
			no_distinct = {}
			no_total = 0
			no_present = 0
			no_withdrew = 0
			no_fta = 0
			
			%>
			
			<h1>Attendance list for all applicants taking exams on 
			<%= @report.from_date.d0? %><% if @report.from_date != @report.to_date %> - <%= @report.to_date.d0? %><% end %></h1>
			<table width="100%">
				<thead>
					<tr>
						<th width="25%">Name</th>
						<th width="15%">SSN</th>
						<th width="60%"><div style="float: right;">Status</div>Exams Attending</th>
					</tr>
				</thead>
				<tbody>
					<% @objs.each { |p| %>
						<tr>
							<td>
								<%= h p.last_name %>, <%= h p.first_name %>
								<% if p.sabbath_observer %>
									<strong>
										**SABBATH OBS.
										<% if !p.sabbath_observer_docs %>
											(NO DOC.)
										<% end %>
									</strong>
								<% end %>
								<% if !p.special_accommodations.blank? %>
									<br />
									<strong>
										**<%= h p.special_accommodations %>
										<% if !p.special_accommodations_docs %>
											(NO DOC.)
										<% end %>
									</strong>
								<% end %>
								<% if p.applicants.to_a.find { |a| a.web_applicant && a.web_applicant.special_accommodations } %>
									<strong>** REQ. ACC.</strong>
								<% end %>
							</td>
							<td>
								<% if @report[:full_ssn] == '1' %>
									<%= h p.ssn %>
								<% else %>
									xxx-xx-<%= h p.ssn_last4 %>
								<% end %>
							</td>
							<td>
								<% p.applicants.each { |a| %>

									<%
									
									no_distinct[p.id] = true
									no_total += 1
									
									if a.app_status
										if a.app_status.code == '-'
											no_fta += 1
										elsif no_withdrew == 'W'
											no_withdrew += 1
										else
											no_present += 1
										end
									end
									
									%>
								
									<div>
										<div style="float: right;"><%= a.app_status ? a.app_status.name : '' %></div>
										<%= h a.exam.title %>: <%= h a.exam.exam_no %><br />
										<% if params[:performance] %>
											<% a.exam.exam_perfs.find(:all, :include => :perf_test, :order => 'perf_tests.name').each { |ep| %>
												<% taken_perf = p.taken_perfs.find(:first, :include => :perf_code, :conditions => ['taken_perfs.exam_id = ? and taken_perfs.perf_test_id = ?', a.exam_id, ep.perf_test_id]) %>
												<div>
													<%= ep.perf_test.name %>: 
													<% if taken_perf %>
														<% if taken_perf.perf_code %>
															<%= taken_perf.perf_code.label %>
														<% end %>
														<%= taken_perf.date_taken.d0? %>
														<%= h taken_perf.time_taken %>
														<%= h taken_perf.notes %>
													<% end %>
												</div>
											<% } %>
										<% else %>
											Exam Site: <%= h a.exam_site.name if a.exam_site %>											
											<% if a.alternate_exam_date %>
												<strong>**ALT DATE: <%= a.alternate_exam_date.d0? %></strong>
											<% end %>
										<% end %>
									<div>
								<% } %>
							</td>
						</tr>
					<% } %>
				</tbody>
			</table>
			<p style="text-align: left;">TOTAL APPLICANTS: <%= no_distinct.keys.size %><br />
			TOTAL APPLICANT/EXAMS: <%= no_total %><br />
			TOTAL PRESENT: <%= no_present %><br />
			TOTAL WITHDREW: <%= no_withdrew %><br />
			TOTAL FTA: <%= no_fta %></p>
		<% end %>
	
	</body>
</html>